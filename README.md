# Капельный полив для дачного участка
Капельный полив на ESP32 с телеграм ботом ([библиотеки Alex Gyver](https://github.com/GyverLibs))

Принцип управление поливом с помощью телеграм бота (Tuya показалась слишком замудренный)

## Необходимые условия
- Wi-Fi сеть с прямым выходом в интернет
- Настроенный телеграм бот ([инструкция как создать и настроить Telegram бота](https://kit.alexgyver.ru/tutorials/telegram-basic/))
- Схема сборки представлена далее

## Принципиальная схема включения ESP32 и компонентов
Необходимо:
- ESP32
- SD CARD модуль 3.3 v
- Кнопка подтянутая на землю
- Датчик освещенности (с сигналом да / нет)
- Датчик дождя (с сигналом да / нет)
- Таймер реального времени подключенный к I2C
- Модуль расширения I2C 8-канальный на базе PCF8574
- 8-канальный релейный модуль для управления клапанами на отсутствует
- Аналоговый коммутатор 74HC4051 (мультиплексор)
- 8-ёмкостных датчиков влажности почвы

![](draw.png)

## Запуск в работу

- Собрать схему
- Скачать исходники с сайта
- Создать Telegram бота (***внимание: у бота необходимо прописать следующий список команд: `reset - сброс состояния,
control - управление поливом,
status - текущий статус,
pause - остановка статусных сообщений,
continue - продолжение получение сообщений`***)
- Поменять токен Telegram bot на свой
- Прошить ESP32

## Алгоритм ввода в рабочее состояние

1. При старте система перейдет в режим настройки Wi-Fi, то есть станет Wi-Fi точкой. Подключаемся к ней и вводим название сети и пароль куда будет подключено наше устройство, ***внимание: запомните сгенерированную кодовую фразу для дальнейшего подключения к боту***, после сохранения настроек система будет перезагружена.
***внимание: если необходимо скинуть устройство к заводским настройкам при перезагрузке зажмите кнопку в течении 3 секунд после старта и дождитесь когда устройство три раза коротко мигнет это означает что сброс удался*** 
2. После перезагрузки запускаем бота, в ответ на первый запрос нас попросят ввести кодовое слово которое мы сохранили. Предварительная настройка завершена теперь вы владелец устройства.
3. Далее выполняем следующие действия:
    - Настраиваем режимы работы
    - Калибруем датчики влажности
    - Задаем название культур 
    - Ставим пороги срабатывания клапанов
4. Система настроена и готова к работе
## Алгоритм работы датчиков
![](block.png)

## Функция заполнения емкости при наступление темноты
Если включен режим энергосбережения то при переходе в режим энергосбережения подается сигнал о необходимости заполнения емкости, чтобы за время энергосбережения прогрелась вода до средней температуры

## Команды бота
- [reset - сброс состояния](#reset)
- [control - управление поливом](#control)
- [status - текущий статус](#status)
- [pause - остановка статусных сообщений](#pause)
- [continue - продолжение получение сообщений](#continue)
## Дерево меню
<a id="admin"></a>
### Для Администратора:
- [Перезагрузка](#restart)
- [Пользователи](#users)
    - [Список](#userslist)
    - [Повышение](#usersup)
    - [Понижение](#usersdown)
    - [Удаление](#usersdel)
    - [Назад](#admin)
- [Управление](#control)
    - [Режим работы](#working)
    - [Названия](#naiming)
    - [Пороги срабатывания](#boreders)
    - [Поиск датчика](#search)
    - [Назад](#admin)
- [Статус](#status)
- [Отчеты](#reports)
    - [Графики](#graphics)
        - [График за вчера](#graphystd)
        - [График за сегодня](#graphtd)
        - [График за декаду](#graphdec)
        - [График за период](#graphp)
        - [График...](#graphс)
        - [Назад](#user)
    - [Файл за вчера](#fileystd)
    - [Файл текущий](#filetd)
    - [Файл...](#fileс)
    - [Назад](#admin)
- [Настройка](#settings)
    - [Работа ночью](#workatnight)
    - [Работа под дождём](#workatrain)
    - [Дельта влажности](#deltahum)
    - [Дельта калибровки](#deltacb)
    - [Калибровка](#calibrate)
    - [Сброс настроек](#restore)
    - [Удаление файлов](#filesdel)
    - [Назад](#admin)
<a id="user"></a>
#### Для Пользователя:
- [Управление](#control)
    - [Режим работы](#working)
    - [Названия](#naiming)
    - [Пороги срабатывания](#boreders)
    - [Поиск датчика](#search)
    - [Назад](#user)
- [Статус](#status)
- [Отчеты](#reports)
    - [Графики](#graphics)
        - [График за вчера](#graphystd)
        - [График за сегодня](#graphtd)
        - [График за декаду](#graphdec)
        - [График за период](#graphp)
        - [График...](#graphс)
        - [Назад](#user)
    - [Файл за вчера](#fileystd)
    - [Файл текущий](#filetd)
    - [Файл...](#fileс)
    - [Назад](#user)

<a id="reset"></a>
#### reset - сброс состояния
Сбрасывает состояние меню и выводит стартовое меню
<a id="control"></a>
#### control - управление поливом / menu: Управление
Открывает меню [Управление](#controls)
<a id="status"></a>
#### status - текущий статус / menu: Статус
Показывает текущее стояние устройства и датчиков
<a id="pause"></a>
#### pause - остановка статусных сообщений
Останавливает сообщения о всех пользовательских событиях генерируемых на устройстве (работает только до перезагрузки устройства)
<a id="continue"></a>
#### continue - продолжение получение сообщений
Запускает сообщения о всех пользовательских событиях генерируемых на устройстве
<a id="restart"></a>
#### menu: Перезагрузка
Перезапускает устройство
<a id="users"></a>
#### menu: Пользователи
<a id="userslist"></a>
##### menu: Список
Список текущих зарегистрированных пользователей (пока только идентификаторы и роли)
<a id="usersup"></a>
##### menu: Повышение
Повышение пользователя в правах (Пользователь -> Администратор)
<a id="usersdown"></a>
##### menu: Понижение
Понижения администраторов в правах невозможно для владельца (Администратор -> Пользователь)
<a id="usersdel"></a>
##### menu: Удаление
Удаление пользователей в системе невозможно для владельца
<a id="controls"></a>
#### menu: Управление
<a id="working"></a>
##### menu: Режим работы
Задание режима работы каждого из клапанов отдельно, можно выбрать следующее:
 - постоянно включен
 - постоянно выключен
 - автоматический режим работы по порогу влажности
<a id="naiming"></a>
##### menu: Названия
Задает название выращиваемой культуры относительно каждого датчика отдельно
<a id="borders"></a>
##### menu: Пороги срабатывания
Задает порог срабатывания каждого из клапанов в процентах от влажности 
<a id="search"></a>
##### menu: Поиск датчика
Поиск датчика влажности если неизвестен его номер, осуществляется как замер влажности в мокрой среде затем в сухой выбираем датчик с наибольшей разницей по данным
<a id="reports"></a>
#### menu: Отчеты
<a id="graphics"></a>
##### menu: Графики
<a id="graphystd"></a>
###### menu: График за вчера
Отчет по часам в виде графиков по влажности и датчикам за вчера 
<a id="graphtd"></a>
###### menu: График за сегодня
Отчет по часам в виде графиков по влажности и датчикам за сегодня
<a id="graphdec"></a>
###### menu: График за декаду
Отчет за последние 10 дней с 60 отсчетами по 6 значений в сутки в виде графиков по влажности и датчикам
<a id="graphp"></a>
###### menu: График за период
Отчет за выбранное количество дней от 1 до 60 отсчетами по формуле `целое (60 / кол-во дней)`  значений в сутки в виде графиков по влажности и датчикам
<a id="graphtс"></a>
###### menu: График...
Отчет за выбранный день в виде графиков по влажности и датчикам
<a id="fileystd"></a>
##### menu: Файл за вчера
Возвращает файл с измерениями за вчера 
<a id="filetd"></a>
##### menu: Файл за сегодня
Возвращает файл с измерениями за сегодня
<a id="fileс"></a>
##### menu: Файл...
Файл с измерениями за выбранный день 
<a id="settings"></a>
#### menu: Настройка
<a id="workatnight"></a>
##### menu: Работа ночью
Настраивает режим работы системы ночью включена или выключена
<a id="workatrain"></a>
##### menu: Работа в дождь
Настраивает режим работы системы во время дождя включена или выключена
<a id="deltahum"></a>
##### menu: Дельта влажности
Настраивает дельту режима работы клапана для ступенчатой работы системы значение в процентах от 0 до 100
<a id="deltacb"></a>
##### menu: Дельта калибровки
Настраивает дельту дельту нижнего и верхнего порога калибровки датчиков влажности значение от 0 до 1024
<a id="calibrate"></a>
##### menu: Калибровка
Калибровка каждого датчика по отдельности происходит как замер в сухом состоянии и вводе разница значений берется за 100 процентов
<a id="restore"></a>
##### menu: Сброс настроек
Возврат к заводским установкам
<a id="filesdel"></a>
##### menu: Удаление файлов
Удаление архивных файлов за предыдущие годы
## Дополнительные функции
### Регистрация пользователя
При запуске работы бота из телеграм если владелец уже зарегистрирован пользователю предложат послать сообщение `администратору` с запросом регистрации, если администратор подтвердит регистрацию данного пользователя он автоматически зарегистрируется как `пользователь` (для повышения прав необходимо повысить пользователя в меню [Повышение](#usersup))
### Удаленное обновление
Если владелец системы пошлет файл с прошивкой (имя файла: `DripIrrigation.ino.bin`) в чат то система попробует обновить прошивку этим файлом
## Известные проблемы
### Бот перестает работать если есть сеть `Wi-Fi`, но длительное время отсутствует `Internet`
Как получили работает система через мобильный интернет базовая станция перестала работать, интернет стал работать очень медленно с большими потерями, так как подключился по 3G к другой базовой станции с очень плохим качеством сигнала. После восстановления канала работа бота не восстановилась.   

